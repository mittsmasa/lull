# アーキテクチャ・設計判断（仮）

## 1. 技術スタック詳細

### フロントエンド

| 項目 | 選定 |
|---|---|
| フレームワーク | Next.js（App Router） |
| 言語 | TypeScript |
| パッケージマネージャ | pnpm |
| CSS | Tailwind CSS v4 |
| UI コンポーネント | shadcn/ui |
| フォーム | React Hook Form |
| バリデーション | Zod |
| データ取得 | TanStack Query + Hono RPC |
| PWA | Serwist |

### バックエンド

| 項目 | 選定 |
|---|---|
| API | Hono RPC（Next.js Route Handler に配置） |
| DB | Cloudflare D1（SQLite ベース） |
| ORM | Drizzle ORM |
| 認証 | Better Auth |
| セッション | DB セッション（D1 に保存） |

### インフラ

| 項目 | 選定 |
|---|---|
| ホスティング | Cloudflare Pages |
| サーバーサイド | Cloudflare Workers / Pages Functions |
| DB | Cloudflare D1 |
| デプロイアダプタ | @opennextjs/cloudflare |

### 開発・運用

| 項目 | 選定 |
|---|---|
| テスト | Vitest（ユニットテスト。E2E は後から追加） |
| CI/CD | GitHub Actions（リント・テスト・デプロイ自動化） |
| リンター | ESLint |

---

## 2. 認証設計

### 管理者・出演者

- **Better Auth** を使用
- ソーシャルログイン: Google OAuth / LINE Login
- セッションは **D1 に保存**（DB セッション方式）
- サーバーサイドで即座にセッション無効化が可能

### ゲスト

- **ログイン不要**
- 招待リンクに含まれるトークンでセッションを識別
- トークンの有効期限はなし（イベントが `archived` になるまで有効）

### 初期管理者

- **シードスクリプト**でデプロイ時に作成
- 環境変数で指定したメールアドレスを管理者として登録

---

## 3. 招待フロー

### 概要

```
出演者がゲスト情報を入力
    ↓
アプリが招待リンク（トークン付き URL）を生成
    ↓
出演者がリンクを自分で共有（LINE・メール等）
    ↓
ゲストがリンクを開く → 招待ページを閲覧
    ↓
ゲストが受諾 or 辞退を選択
    ↓
（イベント当日まで変更可能）
```

### 仕様

- **招待手段**: リンク共有のみ（アプリからの自動送信なし）
- **トークン**: 招待ごとにユニーク。有効期限なし（イベント終了まで有効）
- **返答変更**: 可能（受諾 ⇔ 辞退をイベント当日まで切り替え可）
- **個別メッセージ**: なし（定型の招待ページ）
- **同伴者**: 招待ごとに同伴者数を設定可能。`1 + companion_count` で枠を消費

### 枠数管理

- 管理者がイベントの **座席プール総数**（`total_seats`）を設定
- 出演者ごとに **アロットメント**（`allotment`）を割り当て
- 招待を作成するたびに `1 + companion_count` を出演者の残枠から消費
- 枠数は番号なし・自由席（当日どこに座るかは自由）

---

## 4. 当日運営

### リアルタイム進行

- **MVP では手動リロード方式**
- 管理者が「今の演目」を切り替えると `events.current_program_id` が更新される
- ゲストは画面をリロードして進行状況を確認
- 将来的に SSE やポーリングでリアルタイム同期を追加可能

### チェックイン（受付）

- **QR コード提示** と **名前検索による手動チェックイン** の両方に対応
- ゲストがアプリ上の QR コードを提示 → 管理者/出演者がスキャン
- または、管理者/出演者がゲスト名で検索して手動でチェックイン
- チェックイン時に実際の来場人数（`head_count`）を記録

---

## 5. 画面構成

### レスポンシブ方針

- **モバイルファースト**
- 主にスマートフォンでの利用を想定
- デスクトップでも使えるが、モバイルを最優先で設計

### 管理者・出演者向け

- **ボトムタブ**ナビゲーション
- 主なタブ（想定）:
  - ダッシュボード（イベント概要・ステータス）
  - 招待管理（ゲスト一覧・招待送付・枠状況）
  - プログラム（演目一覧・進行管理）
  - 設定（イベント設定・アカウント）

### ゲスト向け

- **シングルページ**構成
- 招待内容・プログラム・QR コードを 1 ページにまとめる
- セクションスクロールで閲覧

### イベントのライフサイクル

```
draft（準備中）→ inviting（招待中）→ live（当日）→ archived（終了）
```

| ステータス | できること |
|---|---|
| draft | プログラム編集、出演者管理、座席プール設定 |
| inviting | 上記 + 招待送付、ゲスト管理 |
| live | 上記 + 当日進行（演目切り替え）、チェックイン |
| archived | 閲覧のみ（編集不可） |

---

## 6. 通知

- **MVP では通知機能なし**
- 将来的にアプリ内通知や Web Push を検討

---

## 7. 未決事項（将来検討）

- リアルタイム同期方式（SSE / WebSocket / ポーリング）
- Web Push 通知
- E2E テスト（Playwright）
- 環境分離（staging / production）
- QR コード生成ライブラリの選定
- LINE OAuth のチャネル設定詳細
