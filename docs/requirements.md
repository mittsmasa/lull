# Lull - 要件定義

## 1. プロダクト概要

**Lull** は、ピアノ発表会などの小規模コンサート・リサイタルを運営するためのWebアプリケーション。
イベントの企画から当日の受付・進行管理までをカバーする。

## 2. ロール定義

| ロール | 説明 | 認証 |
|--------|------|------|
| **主催者（Organizer）** | イベントを作成・管理する人。出演者の招集、ゲスト招待・座席枠の管理を行う。出演者がもつすべての権限を含む | Google OAuth でログイン |
| **出演者（Performer）** | イベントに出演する人。プログラム編集、ゲスト招待ができる。ゲストがもつすべての権限を含む | Google OAuth でログイン |
| **ゲスト（Guest）** | 招待リンク経由で出欠を回答する観客。アカウント不要 | 招待トークン（URLリンク） |

### ロールの補足

- ロールは階層構造：主催者 ⊃ 出演者 ⊃ ゲスト（上位は下位の全権限を含む）
- 主催者と出演者は `event_members.role` で区別される（イベントごとに異なるロールを持てる）
- 一人のユーザーが、あるイベントでは主催者、別のイベントでは出演者になれる
- ゲストはログイン不要。招待リンクのトークンで識別する
- イベント作成時、作成者は自動的に主催者（Organizer）として `event_members` に登録される。`displayName` の初期値は Google アカウントの表示名（`users.name`）を使用する。`displayName` は NOT NULL とする（1〜50 文字）
- 1 つのイベントにつき主催者は 1 名のみ（作成者）。主催者の追加・変更はできない

### 招待トークンの仕様

- トークンは URL-safe なランダム文字列（最低 22 文字 / 128 bit エントロピー以上）
- 出演者向け招待リンク・ゲスト向け招待リンクともに同じトークン形式
- **出演者招待トークン**: 1 回限りの使用。参加確定でトークンのステータスを `accepted` に変更し、以降は他のユーザーによるアクセス不可（受諾済みの本人がアクセスした場合はイベント詳細へリダイレクト）
- **ゲスト招待トークン**: 出欠回答後もトークンは有効なまま維持する。ゲストは同じリンクで回答内容の確認・変更・QRコードの表示が可能
- 有効期限（ゲスト招待・出演者招待共通）: イベント終了（`finished`）まで。`finished` 後のアクセスは「この招待リンクは期限切れです」を表示する。出演者招待の場合、`accepted` 済みのトークンは既にメンバー登録済みのため有効期限の影響を受けない（`pending` のまま `finished` を迎えたトークンは期限切れとなる）
- 主催者はリンクを無効化（招待の取り消し）できる。ゲスト招待リンクについては、招待を発行した出演者も無効化可能（権限マトリクス参照）
- **出演者招待トークンの無効化**: 無効化されたトークンではページにアクセスできない（エラー画面を表示）
- **ゲスト招待トークンの無効化**: 回答前（`pending`）の無効化はアクセス不可。回答済み（`accepted` / `declined`）の無効化は回答変更を不可にするが、`accepted` のゲストは引き続きページで QR コードを閲覧可能（来場は有効のまま）

### 出演者招待リンクのフロー

1. 主催者がメンバー管理画面で表示名を入力し、招待リンクを発行
2. リンクを受け取った人がアクセス → 未ログインなら Google OAuth に遷移
3. ログイン後、イベント名・表示名を確認する画面を表示（表示名は読み取り専用。変更は参加後にイベント詳細から行う） → 「参加する」ボタンで確定
4. 参加確定で `event_members` に出演者として登録される。`displayName` は `performer_invitations.displayName`（主催者が設定した表示名）を使用する。トークンは使用済み（ステータス: `accepted`）となり、イベント詳細画面にリダイレクト

#### エッジケース

- **既にイベントメンバーの人が同じイベントの招待リンクを踏んだ場合**: トークンは消費せず、イベント詳細画面にリダイレクトする（「既に参加しています」のトースト表示）
- **主催者が自分のイベントの出演者招待リンクを踏んだ場合**: 上記と同じ扱い（既にメンバーのためリダイレクト）
- **受諾済みトークンに受諾した本人がアクセスした場合**: トークンは消費せず、イベント詳細画面にリダイレクトする
- **受諾済みトークンに別のユーザーがアクセスした場合**: 「この招待リンクは既に使用済みです」エラー画面を表示
- **無効化済みのトークンにアクセスした場合**: 「この招待リンクは無効です」エラー画面を表示
- **期限切れのトークンにアクセスした場合**（イベントが `finished`）: 「この招待リンクは期限切れです」エラー画面を表示

## 3. 機能一覧

### 3.1 認証

- [x] Google OAuth サインイン / サインアウト

### 3.2 イベント管理

- [ ] イベント作成（名前、日時、会場、座席数）
- [ ] イベント一覧（自分が関わるイベントのみ表示）
- [ ] イベント詳細・編集
- [ ] イベントステータス管理（draft → published → ongoing → finished）
- [ ] イベントの削除

#### イベント作成時のバリデーション

| フィールド | 必須 | 制約 |
|-----------|:----:|------|
| イベント名 | ○ | 1〜100 文字 |
| 開催日 | ○ | YYYY-MM-DD 形式。当日以降であること |
| 開演時刻 | ○ | HH:mm 形式 |
| 開場時刻 | — | HH:mm 形式（任意）。指定する場合は開演時刻以前であること（同日内の時刻比較。日をまたぐケースは想定しない） |
| 会場 | ○ | 1〜200 文字 |
| 座席数（totalSeats） | ○ | 0〜9999 の整数。0 は無制限（座席枠チェックをスキップ） |

> **DB 保存形式**: フォーム入力の開催日 + 開演時刻は `startDatetime`（`"YYYY-MM-DDTHH:mm"` 形式）として、開催日 + 開場時刻は `openDatetime`（同形式、nullable）として DB に保存する。DB には `date` / `startTime` / `openTime` の個別カラムは持たない

#### イベント編集ルール（ステータス別）

- **`draft` / `published` で編集可能**: イベント名、会場
- **条件付き編集可能**: 座席数（totalSeats）— `draft` / `published` で変更可能。0（無制限）への変更も可能。0 以外に変更する場合、accepted 済みゲストが存在するときは、変更後の値が「現在の座席消費数（accepted 状態のゲスト数 + 同伴者数。無効化済みの accepted を含む）」以上であること。下回る場合はエラーとする
- **条件付き編集可能**: 開催日時（startDatetime / openDatetime）— `draft` / `published` では変更可能、`ongoing` / `finished` では変更不可。編集時も開催日は「当日以降」の制約、開場時刻は「開演時刻以前」の制約を適用する
- **`ongoing` / `finished` ではイベントプロパティの編集を不可とする**（ステータス遷移、招待管理の操作、チェックイン操作は引き続き可能）

#### イベントステータス遷移ルール

```
draft ──→ published ──→ ongoing ──→ finished
  ↑            │
  └────────────┘
       (差し戻し)
```

- `draft → published`: ゲスト招待を開始できる状態にする。前提条件は設けない（プログラム 0 件・出演者が主催者のみでも公開可能）
- `published → draft`: 差し戻し。ただし既存の招待は保持される（ゲストからは一時的にアクセス不可）
- `published → ongoing`: 主催者が手動で切り替え（当日の開演時を想定）
- `ongoing → finished`: 主催者が手動で切り替え（終演時を想定）
- `finished` からの遷移は不可（確定状態）。ただしイベント詳細・プログラム・メンバー・招待状況・チェックイン結果は引き続き閲覧可能（読み取り専用）
- キャンセルフローは設けない（`draft` に戻して削除で対応）

#### published → draft 差し戻し時の挙動

- 既存のゲスト招待リンク（pending / accepted / declined）はすべて保持される。出演者招待トークン（pending / accepted）も同様に保持される
- ゲストが招待回答ページ（`/i/[token]`）にアクセスした場合は「現在準備中です」画面を表示し、回答操作は不可とする
- 出演者招待ページ（`/join/[token]`）は `draft` でも通常通り受諾可能（出演者の参加はイベント公開前から可能）
- 差し戻し後に再度 `published` にすると、保持されていた招待リンクが再び有効になる

#### イベント削除の制約

- `draft` ステータスのみ削除可能
- `published` 以降のイベントは削除不可（ゲストに招待リンクが渡っている可能性があるため）
- 削除したい場合は `published → draft` に差し戻してから削除する
- **削除時の注意**: 差し戻し後に削除すると、既存の招待・プログラム・メンバー情報はすべてカスケード削除される。accepted 済みのゲストも招待ページにアクセスできなくなる。削除前に確認ダイアログを表示し、影響範囲（招待数等）を提示する

### 3.3 メンバー管理

- [ ] イベントへの出演者追加（表示名付き招待リンクを発行 → クリップボードコピー or SNS送信）
- [ ] 出演者の表示名（displayName）設定・変更
  - [ ] 主催者が招待時に表示名を設定（1〜50 文字）
  - [ ] 出演者自身が表示名を変更可能（1〜50 文字）
  - [ ] 表示名の変更は `draft` / `published` / `ongoing` で可能。`finished` では変更不可
- [ ] 出演者の削除（主催者のみ）
  - [ ] プログラムに紐づいている出演者は削除不可（先にプログラムから外す必要がある）
  - [ ] 削除すると当該出演者の招待リンク（ゲスト向け）はそのまま維持される（招待者名は `inviterDisplayName`（スナップショット）に「（削除済み）」を付けて表示。例:「山田太郎（削除済み）」）
- [ ] 出演者の招待リンクの無効化（主催者のみ）

#### 出演者招待の補足

- **辞退機能なし**: 出演者招待には「辞退」の概念はない。招待リンクを受け取った人は「参加する」か「無視する」のいずれか。辞退が必要な場合はリンクを無視し、主催者が招待を無効化する運用とする
- **出演者招待トークンの無効化遷移**: `pending → invalidated` のみ。`accepted` 済みの出演者招待トークンは無効化不可（既にメンバーとして登録済みのため、メンバー削除は別操作で行う）
- **出演者招待トークンの受諾可能なイベントステータス**: `draft` / `published` / `ongoing` で受諾可能。`finished` では期限切れ扱い
- **出演者招待リンク無効化のステータス制約**: `draft` / `published` / `ongoing` で可能。`draft` / `published` で発行された未受諾トークンが `ongoing` に持ち越される場合があるため、`ongoing` でも無効化可能とする。`finished` では不可

#### メンバー管理の補足

- 削除された出演者を再度招待することは可能（新しい招待リンクを発行する）
- 出演者の人数上限は設けない（座席数とは独立）
- **イベントステータス別の制約**: 出演者の追加（招待リンク発行）は `draft` / `published` で可能。`ongoing` / `finished` では新規招待不可。出演者の削除は `draft` / `published` で可能。`ongoing` / `finished` では削除不可
- **出演者削除時のデータ保持**: 出演者を削除（`event_members` から削除）する際、当該出演者が発行したゲスト招待（`invitations`）は維持する必要がある。`invitations.memberId` の外部キーは `onDelete: 'set null'` とし、招待者名は `invitations` に `inviterDisplayName` として保存する。表示時は `memberId` が null の場合、`inviterDisplayName` に「（削除済み）」を付けて表示する（例:「山田太郎（削除済み）」）
- **`inviterDisplayName` はスナップショット**: 招待リンク発行時点の出演者表示名を `inviterDisplayName` に保存する。出演者が後から表示名を変更しても、既発行の招待の `inviterDisplayName` は更新されない

### 3.4 プログラム管理

- [ ] プログラム（演目）の追加・編集・削除
- [ ] プログラムの並び替え（ドラッグ＆ドロップ）
- [ ] プログラム種別（固定 enum: `performance`（演奏）/ `intermission`（休憩）/ `greeting`（あいさつ）/ `other`（その他））
- [ ] 演目への出演者の紐付け
- [ ] 予定時刻・所要時間の設定

#### プログラム管理の補足

- **出演者の紐付け**: `performance` では 1 名以上の出演者が必須。`intermission` / `greeting` / `other` では出演者の紐付けは任意（0 名でも可）
- **複数出演者の紐付け**: 1 つの演目に複数の出演者を紐付けられる（連弾・アンサンブル等）。中間テーブル `program_performers` で管理する
- **編集権限の範囲**: 出演者はイベント内の全プログラムを追加・編集・削除できる（自分が紐付いた演目に限定しない）
- **並び順**: プログラムは `sortOrder`（整数）で管理する。削除時は自動的に詰め直す（例: 1, 2, 3 の 2 を削除 → 1, 2 に振り直し）
- **予定時刻・所要時間**: いずれも任意項目。所要時間の単位は分（整数）
- **同時編集**: 複数の出演者が同時にプログラムを編集した場合は楽観的ロックは設けず、last-write-wins とする
- **イベントステータス別の制約**: `draft` / `published` / `ongoing` ではプログラムの追加・編集・削除が可能。`finished` では読み取り専用（編集不可）

#### プログラムのバリデーション

| フィールド | 必須 | 制約 |
|-----------|:----:|------|
| タイトル | ○ | 1〜200 文字 |
| 種別（type） | ○ | `performance` / `intermission` / `greeting` / `other` のいずれか |
| 出演者 | △ | `performance` の場合は 1 名以上必須 |
| 作曲者 | — | 0〜200 文字（任意） |
| 予定時刻 | — | HH:mm 形式（任意） |
| 所要時間 | — | 1〜999 の整数（分単位、任意） |
| 備考 | — | 0〜500 文字（任意） |

### 3.5 招待管理

- [ ] ゲスト招待リンクの発行（一意のトークン付きURL → クリップボードコピー or SNS送信。座席枠はゲストの出席回答時に消費される）
- [ ] ゲスト側：招待リンクから出欠回答
  - [ ] 名前・メールアドレスは必須
  - [ ] 同伴者がいる場合は同伴者の名前を個別に入力
- [ ] 招待ステータス管理（下記状態遷移図参照）
- [ ] 招待状況ダッシュボード。出演者は自分が発行した招待だけでなく、イベント全体の招待状況を閲覧可能。表示項目:
  - 総座席数（totalSeats）
  - 残り枠（totalSeats − 消費済み座席数）
  - 招待済み（発行済みの全招待数。pending + accepted + declined。無効化済みには「無効化済み」ラベルを付与）
  - 回答待ち（pending 状態の招待数）
  - 出席（accepted 状態の招待数 + 同伴者数）
  - 辞退（declined 状態の招待数）
- [ ] ゲストの出欠回答の変更
  - [ ] `accepted → declined`: 可能。座席枠が共有プールに返却される。既存の同伴者データは削除する（座席を解放するため）
  - [ ] `declined → accepted`: 空き枠がある場合のみ可能。同伴者は 0 名の状態から新たに追加する（`accepted → declined` 時に削除済みのため復元はしない）
  - [ ] 同伴者の追加・削除: 出欠変更時に可能（空き枠の範囲内）
- [ ] ゲスト招待リンクの無効化（主催者・招待を発行した出演者が可能）
- [ ] 主催者によるゲスト出欠ステータスの代理変更（accepted → declined、declined → accepted（空き枠がある場合のみ）、pending の場合は代理変更不可（ゲスト本人の回答を待つ））

#### ゲスト招待リンク発行・無効化のステータス制約

- **リンク発行**: `published` / `ongoing` で可能。`draft` では不可（ゲストが回答ページにアクセスしても「現在準備中です」となり意味がないため）。`finished` では不可
- **リンク無効化**: `published` / `ongoing` で可能。`finished` では不可

#### 招待ステータスの状態遷移

```
pending ──→ accepted
  │            ↕
  └────→ declined
```

- `pending → accepted`: ゲストが出席回答（空き枠チェックあり）
- `pending → declined`: ゲストが辞退回答
- `accepted → declined`: ゲスト本人の変更、または主催者の代理変更。同伴者データは削除され、ゲスト本人および同伴者のチェックイン状態（`checkedIn` / `checkedInAt`）もすべてリセットされる
- `declined → accepted`: ゲスト本人の変更、または主催者の代理変更（空き枠がある場合のみ）
- イベントステータス別の回答制約については「出欠回答の制約（イベントステータス別）」セクションを参照

#### 招待リンク発行時の入力

- 招待リンクの発行時に、招待者（主催者・出演者）はゲストの情報を入力しない
- 発行ボタンを押すとトークン付きURLが即座に生成される
- ゲストの名前・メールアドレスは、ゲスト自身が招待回答ページで入力する
- メールアドレスは主催者がゲストを識別・連絡するための情報として収集する（アプリ内での自動通知には使用しない）

#### 招待回答ページ（`/i/[token]`）の表示内容

- イベント名、開催日時、会場
- 招待者（リンクを発行した主催者または出演者）の表示名
- 出欠回答フォーム（名前・メールアドレス・出欠・同伴者）
- 回答済みの場合は現在の回答内容を表示し、変更フォームを表示する。ただし以下の場合は変更フォームを非表示にする：
  - 無効化済みの場合: 「この招待は変更できません」と表示
  - イベントが `ongoing` / `finished` の場合: 「回答の変更期間は終了しました」と表示

#### 出欠変更時のゲスト情報

- ゲストが出欠を変更する際、名前・メールアドレスも変更可能とする（変更フォームに現在の値をプリフィルする）
- `accepted → declined` に変更した場合でも、ゲスト名・メールアドレスは保持する（削除しない）。再度 `declined → accepted` に変更した場合に再入力不要とするため

#### 同伴者の制約

- 1 招待あたりの同伴者の上限: **4 名**（ゲスト本人を含め最大 5 席）
- 同伴者の追加は空き枠の範囲内でのみ可能

#### ゲストの重複招待

- 同一イベントで同じゲスト（同一メールアドレス）が複数の招待リンクから回答することを制限しない。異なる出演者から独立に招待される運用を想定する
- 重複の検知・統合は初期バージョンでは行わない（招待状況ダッシュボードで主催者が確認する運用）

#### 座席共有プールの仕様

- `events.totalSeats` がイベント全体の座席上限
- **出演者は座席数に含まない**（座席はゲスト・同伴者のためのもの）
- ゲスト本人 = 1 席、同伴者 1 名 = 1 席としてカウント
- 残り枠の計算式:
  ```
  残り枠 = totalSeats − (accepted ゲスト数 + accepted ゲストの同伴者数)
  ```
  ※ `totalSeats` が 0（無制限）の場合、残り枠チェックはスキップする（常に出席回答を受け付ける）
  ※ `accepted` ゲスト数には無効化済み（`invalidatedAt` あり）の `accepted` も含む。無効化済みでも座席を消費し続ける（セクション 3.5「招待無効化後の出席ステータス」参照）
- 残り枠が 0 の場合でも、新規招待リンクの発行は可能とする（pending は枠を消費しないため）
- 既に発行済みの招待リンク（pending 状態）は枠を消費しない（回答時に枠チェック）
- 枠の確認は出席回答（accepted）の確定時のみ行う

#### 座席競合（同時回答）の制御

- 回答の確定時に DB レベルで残り枠を再チェックする（トランザクション内でのアトミックチェック）
- 枠が不足している場合は「満席のため出席回答を受け付けられません」エラーを返す
- pending が枠を消費しない設計上、同時回答による競合が発生しうるが、上記のトランザクション内チェックで防止する

#### 招待回答のバリデーション

| フィールド | 必須 | 制約 |
|-----------|:----:|------|
| ゲスト名 | ○ | 1〜100 文字 |
| メールアドレス | ○ | 有効なメール形式 |
| 出欠 | ○ | `accepted` / `declined` のいずれか |
| 同伴者名 | △ | 出欠が `accepted` の場合のみ入力可。同伴者がいる場合は 1〜100 文字。最大 4 名。`declined` の場合は同伴者入力不可 |

#### 満席時の招待回答ページの表示

- 招待回答ページ（`/i/[token]`）にアクセスした時点で残り枠が 0 の場合、フォーム自体は表示するが「現在満席です。出席回答を送信しても受け付けられない可能性があります」の注意文を表示する
- 出席回答（accepted）の送信時に残り枠が不足していた場合は「満席のため出席回答を受け付けられません」エラーを表示する
- 辞退（declined）は満席に関わらず常に送信可能

#### 招待無効化後の出席ステータス

- `accepted` 済みの招待を無効化した場合、ゲストの出席扱いは維持される（座席を消費し続ける）
- チェックイン時、無効化済みであっても `accepted` のゲストは通常通りチェックイン可能
- 無効化は「これ以上の回答変更を防ぐ」目的であり、確定済みの出席を取り消すものではない
- 出席自体を取り消したい場合は、主催者が招待管理画面でステータスを `declined` に手動変更する（※ 主催者による代理操作）。無効化済みの招待であっても、主催者はステータスの代理変更が可能

#### 出欠回答の制約（イベントステータス別）

- **初回回答**（pending → accepted / declined）: `published` / `ongoing` で可能
- **回答変更**（accepted ↔ declined）: `published` の間のみ可能。`ongoing` / `finished` では変更不可（当日以降は確定扱い）
- **主催者の代理変更**: `pending` 以外のステータスに対して、`published` / `ongoing` で可能。`finished` では不可

#### 無効・期限切れリンクへのアクセス

- **無効化されたトークン（pending）**: 「この招待リンクは無効です」エラー画面を表示
- **無効化されたトークン（accepted）**: 招待回答ページは閲覧可能（QRコード表示あり）。ただし回答変更フォームは非表示とし、「この招待は変更できません」と表示する
- **無効化されたトークン（declined）**: 「この招待リンクは無効です」エラー画面を表示
- **期限切れ（イベントが `finished` になった後）**: 「この招待リンクは期限切れです」エラー画面を表示
- **イベントが `ongoing` 状態のトークン**:
  - `pending`: 初回回答フォームを表示する（`ongoing` でも初回回答は可能）
  - `accepted`: 回答内容と QR コードを表示する。回答変更フォームは非表示とし、「回答の変更期間は終了しました」と表示する
  - `declined`: 回答内容を表示する（QR コードなし）。回答変更フォームは非表示とし、「回答の変更期間は終了しました」と表示する
- **イベントが `draft` 状態のトークン**: 「現在準備中です」画面を表示

### 3.6 当日チェックイン

- [ ] QRコードで来場受付
  - [ ] QRコードの内容: 招待回答ページの URL（`/i/[token]`）をエンコード
  - [ ] チェックイン画面（`/events/[eventId]/checkin`）上でカメラを起動し、ゲストが提示するQRコードを読み取る → URLからトークンを抽出し、該当イベントの招待であることを検証 → ゲストの情報を表示 → 来場確認ボタンを押す
  - [ ] 本人・各同伴者の個別来場記録
- [ ] リアルタイムの来場者数カウント

#### チェックインの補足

- **チェックイン可能なイベントステータス**: `ongoing` のみ。`draft` / `published` / `finished` ではチェックイン操作不可
- **チェックイン対象**: `accepted` ステータスのゲストのみ。`declined` のゲストのトークンを読み取った場合は「この招待は辞退されています」エラーを表示する。`pending` のゲストはQRコードが表示されないため通常は発生しないが、URLを手動入力された場合は「この招待はまだ出欠回答されていません」エラーを表示する
- **同伴者の部分来場**: チェックイン時にゲスト本人および各同伴者の来場を個別に記録できる（本人のみ来場、同伴者の一部が来場、など）
- **チェックインの取り消し**: 誤操作に対応するため、チェックイン済みのゲスト・同伴者を個別に「未来場」に戻すことが可能（主催者・出演者が操作）。取り消しは `ongoing` のみ可能（`finished` では取り消し不可）
- **別イベントのQRコード**: 読み取ったトークンが現在のチェックイン画面のイベントと異なる場合は「このQRコードは別のイベントのものです」エラーを表示する
- **二重チェックイン防止**: 既にチェックイン済みの QR を読み取った場合は「既にチェックイン済みです」と表示する（エラーではなく情報表示）

### 3.7 進行管理（ライブ） ※ optional

- [ ] 現在の演目をリアルタイムで切り替え（currentProgramId）
- [ ] ゲスト向けプログラムビュー（今どの演目か表示）

## 4. 権限マトリクス

| 機能 | 主催者 | 出演者 | ゲスト |
|------|:------:|:------:|:------:|
| **イベント管理** | | | |
| イベント作成 | ○ | | |
| イベント編集・削除 | ○ | | |
| イベントステータス変更 | ○ | | |
| イベント一覧の閲覧 | ○ | ○ | |
| イベント詳細の閲覧 | ○ | ○ | |
| **メンバー管理** | | | |
| メンバー一覧の閲覧 | ○ | ○ | |
| 出演者の追加（招待リンク発行） | ○ | | |
| 出演者の削除 | ○ | | |
| 出演者の表示名を設定 | ○ | | |
| 自分の表示名を変更 | ○ | ○ | |
| **プログラム管理** | | | |
| プログラムの追加・編集・削除 | ○ | ○ | |
| プログラムの並び替え | ○ | ○ | |
| **招待管理** | | | |
| ゲストを招待（リンク発行） | ○ | ○ | |
| ゲスト招待リンクの無効化 | ○ | ○* | |
| 出演者招待リンクの無効化 | ○ | | |
| 招待状況ダッシュボードの閲覧 | ○ | ○ | |
| 招待リンクから出欠回答 | | | ○ |
| 出欠回答の変更 | | | ○ |
| ゲストの出欠ステータスを代理変更 | ○ | | |
| **当日チェックイン** | | | |
| QRコード読み取り・来場確認 | ○ | ○ | |
| チェックインの取り消し | ○ | ○ | |
| 来場者数カウントの閲覧 | ○ | ○ | |
| **進行管理（optional）** | | | |
| 現在の演目を切り替え | ○ | | |
| ライブビューの閲覧 | ○ | ○ | ○ |

> *○\*: 出演者は自分が発行したゲスト招待リンクのみ無効化可能*
>
> *凡例: ○ = 可能、空白 = 不可（権限なし）*

## 5. 画面構成・遷移

### 5.1 画面一覧

| 画面名 | パス | 認証 | 概要 |
|--------|------|:----:|------|
| トップ | `/` | 不要 | サインインボタン。ログイン済みならダッシュボードへリダイレクト |
| ダッシュボード | `/dashboard` | 要 | 自分が関わるイベント一覧。イベント作成ボタンを配置 |
| イベント作成 | `/events/new` | 要 | イベント新規作成フォーム |
| イベント詳細 | `/events/[eventId]` | 要 | イベント情報のサマリ表示・編集、各管理画面へのナビゲーション（下記補足参照） |
| プログラム編集 | `/events/[eventId]/programs` | 要 | 演目の追加・並び替え・編集 |
| メンバー管理 | `/events/[eventId]/members` | 要 | 出演者一覧・招待リンク発行 |
| 招待管理 | `/events/[eventId]/invitations` | 要 | 招待一覧・リンク発行・状況確認 |
| チェックイン | `/events/[eventId]/checkin` | 要 | QRコード読み取り・来場受付 |
| ライブビュー | `/events/[eventId]/live` | 不要 | 現在の演目表示（認証不要・eventId を知っていれば誰でも閲覧可）（optional） |
| 出演者招待受諾 | `/join/[token]` | 要 | 出演者招待リンクのランディングページ。イベント名・表示名を確認し「参加する」で確定 |
| 招待回答 | `/i/[token]` | 不要 | ゲストの出欠回答ページ |
| エラー | — | 不要 | 各種エラー表示（下記参照） |

#### イベント詳細画面の補足

- イベント基本情報（名前、日時、会場、座席数、ステータス）を表示
- 主催者にはイベント編集フォーム・ステータス変更ボタン・削除ボタンを表示（インライン編集）
- 出演者には編集不可の閲覧ビューを表示
- サマリ情報: メンバー数、プログラム数、招待状況（残り枠 / 招待済み / 回答待ち）
- 各管理画面（プログラム、メンバー、招待、チェックイン）へのナビゲーションリンク

#### 招待回答完了後の遷移

- 出欠回答を送信後、同じ `/i/[token]` ページ上に回答済み内容を表示する（別画面への遷移はしない）
- 回答済みの場合、ページ訪問時に現在の回答内容と変更フォームを表示する
- `accepted` の場合、QRコードを同ページ内に表示する（来場時に提示するため）

#### QRコードの表示

- ゲストが出席回答（`accepted`）すると、招待回答ページ（`/i/[token]`）にQRコードを表示する
- QRコードの内容は招待回答ページの URL そのもの（`/i/[token]`）
- ゲストはこのページをスクリーンショットまたはブックマークして当日持参する

#### エラー画面

| ケース | 表示内容 |
|--------|----------|
| 404（ページが見つからない） | 「ページが見つかりません」 |
| 403（権限なし） | 「このページにアクセスする権限がありません」 |
| 存在しないトークン（DB に該当なし） | 「この招待リンクは無効です」 |
| 無効化されたトークン（pending / declined） | 「この招待リンクは無効です」 |
| 使用済み出演者招待トークン（別ユーザーがアクセス） | 「この招待リンクは既に使用済みです」 |
| 期限切れトークン（イベントが `finished`） | 「この招待リンクは期限切れです」 |
| draft 状態のイベントへのゲストアクセス | 「現在準備中です」 |

### 5.2 ダッシュボードの表示ルール

- 未終了イベント（`draft` / `published` / `ongoing`）は `startDatetime` の昇順で表示（直近のイベントが上。過去日の未終了イベントも先頭に表示される）
- `finished` イベントは一覧の末尾にまとめて表示（`startDatetime` の降順＝最近終了したイベントが上）
- 各イベントカードにはイベント名、開催日時（`startDatetime`）、会場、ステータスバッジを表示
- イベント作成ボタンを画面上部に配置

### 5.3 画面遷移図

```
[トップ /]
  │
  ├─ (ログイン済み) ──→ [ダッシュボード /dashboard]
  │                        │
  │                        ├──→ [イベント作成 /events/new]
  │                        │       │
  │                        │       └─ (作成完了) ──→ [イベント詳細]
  │                        │
  │                        └──→ [イベント詳細 /events/[eventId]]
  │                                │
  │                                ├──→ [プログラム編集 /events/[eventId]/programs]
  │                                ├──→ [メンバー管理 /events/[eventId]/members]
  │                                ├──→ [招待管理 /events/[eventId]/invitations]
  │                                ├──→ [チェックイン /events/[eventId]/checkin]
  │                                └──→ [ライブビュー /events/[eventId]/live]
  │
  └─ (未ログイン) ──→ Google OAuth

[出演者招待受諾 /join/[token]]  ← 出演者招待リンクから直接アクセス
  │
  ├─ (未ログイン) ──→ Google OAuth ──→ [出演者招待受諾]
  ├─ (既にメンバー) ──→ [イベント詳細]（トースト表示）
  └─ (参加確定) ──→ [イベント詳細]

[招待回答 /i/[token]]  ← ゲスト招待リンクから直接アクセス（独立フロー）
```

## 6. 技術スタック

- **フロントエンド**: Next.js 16 + React 19 + Tailwind CSS 4 + shadcn/ui（new-york スタイル）
- **API**: Hono（認証ルート `/api/auth/*` と `/api/health` のみ）。データ変更操作は Server Actions で実装する
- **認証**: Better Auth (Google OAuth)
- **DB**: SQLite + Drizzle ORM
- **テスト**: Vitest + Storybook
- **リンター / フォーマッター**: Biome
- **パッケージマネージャ**: pnpm（`npx` は使用禁止。`pnpm dlx` を使う）

### 6.1 デザインシステム

[v0-design-aesthetic-guidance](https://github.com/mittsmasa/v0-design-aesthetic-guidance) に準拠する。「余白が、語る。情報を詰め込むのではなく、大切なことだけを、丁寧に届ける」が基本理念。

- **フォント**: `font-sans`（Noto Serif JP）を本文・UI 要素、`font-serif`（Shippori Mincho）を見出し・ロゴに使用
- **カラー**: 生成り（kinari）ベースの暖色系。primary はテラコッタ、accent はキャメル、foreground は墨色
- **余白**: 「呼吸する余白」— 密度より間を重視。セクション間は十分な gap を確保
- **角丸**: `rounded-sm` を基本（過度な丸みはカジュアルになりすぎるため避ける）
- **タイポグラフィ**: 見出しに `font-serif font-light tracking-wide`、本文に `leading-relaxed`、キャプションに `text-xs tracking-[0.2em] uppercase`
- **カード**: 情報を詰め込まず、呼吸のある構成。タイトルに `font-serif font-light tracking-wide`
- **モーション**: 0.2〜0.4秒 ease-out、hover scale は 1.02 以下。派手なアニメーションは非推奨
- **フォーム**: Label + Input を `flex flex-col gap-2` で縦並び。合成フォームは `rounded-sm border bg-card p-8` + `gap-6`

### 6.2 アーキテクチャ・実装規約

全機能で共通して適用するパターン。

#### データ変更: Server Actions

- データの作成・更新・削除は Server Actions（`"use server"`）で実装する
- Hono API エンドポイントは認証（`/api/auth/*`）とヘルスチェック（`/api/health`）のみ
- `src/server/index.ts` には新しいルートを追加しない

#### 認証ヘルパー: `src/lib/session.ts`

- `import "server-only"` でクライアントバンドルへの混入を防止
- `getSession()`: セッションを取得（未認証なら `null`）
- `requireSession()`: セッションを取得（未認証ならトップページにリダイレクト）
- Server Component や Server Action の冒頭で呼び出す

#### データアクセス層: `src/lib/queries/`

- DB クエリは `src/lib/queries/` 配下に server-only 関数として切り出す（ページコンポーネント内で直接 `db.query.*` を呼ばない）
- cross-table ソートが必要な場合は `db.select().from().innerJoin().orderBy()` パターンを使用する（Drizzle リレーショナルクエリは join 先の `orderBy` をサポートしないため）
- 返り値には明示的な型を定義し、ページコンポーネントとの契約を明確化する

#### スキーマ規約

- 全テーブルの `id` に `$defaultFn(() => crypto.randomUUID())` で UUID 自動生成
- `createdAt` に `$defaultFn(() => Date.now())`、`updatedAt` に `$defaultFn(() => Date.now()).$onUpdateFn(() => Date.now())`
- enum 値は `as const` 配列 + 型エクスポートで定義（例: `EVENT_STATUSES` / `EventStatus`）。Drizzle の `text("col", { enum: ... })` と組み合わせて型安全にする
- `$defaultFn` / `$onUpdateFn` はアプリケーション層（Drizzle ORM）で動作。SQL の DEFAULT 句は生成されない
- `$onUpdateFn` は Drizzle の `.update()` 使用時のみ自動実行される

#### SQLite (better-sqlite3) + Drizzle ORM の注意事項

- **`db.transaction()` に async 関数を渡してはいけない**: better-sqlite3 は同期ドライバのため、`db.transaction(async (tx) => { ... })` は `Transaction function cannot return a promise` エラーになる
- **Server Actions でのトランザクション回避策**: Server Actions は async 関数のため、`db.transaction()` の同期コールバックとの相性が悪い。複数の INSERT が必要な場合は、トランザクションを使わず順次 `await` で実行する（SQLite は単一ライター・単一ファイルのため、実質的に安全）
- **本番（Cloudflare D1）では非同期トランザクションが使えるため、D1 移行時にトランザクションの導入を検討する**

#### フォーム送信: React 19 `useActionState`

- フォーム送信は `useActionState(serverAction, initialState)` で状態管理する
- Server Action の第 1 引数は `prevState`（`useActionState` 用）、第 2 引数は `FormData`
- 成功時は Server Action 内で `redirect()` する。失敗時は `{ error: string }` を返す

#### キャッシュ無効化: `revalidatePath()`

- Server Action でデータ変更後、`revalidatePath()` で関連ページのキャッシュを無効化する
- `redirect()` は内部で例外を throw するため、必ず `revalidatePath()` を `redirect()` より先に呼ぶ
- 変更の影響を受ける全ページパスを `revalidatePath()` する（例: 一覧ページ + 詳細ページ）

#### ページコンポーネント

- 動的ルートの props 型は Next.js グローバル型 `PageProps<"/path/[param]">` を使用する（import 不要。Next.js が自動生成）
- ページは Server Component で実装し、インタラクティブな部分のみ Client Component に分離する

#### Storybook

- props ベースで動作する純粋な表示コンポーネントは Storybook ストーリーを作成する
- Server Action に依存するコンポーネントは Storybook 対象外（必要に応じて後続で追加）

## 7. 通知・コミュニケーション

- アプリ内通知やメール通知の機能は設けない
- 招待リンクの共有は、発行者が手動でクリップボードコピーまたは SNS 送信で行う
- 出欠回答の変更通知なども行わない（招待状況ダッシュボードで確認する運用）

## 8. データ保持

- `finished` イベントのデータは永続的に保持する（自動削除しない）
- 将来的にアーカイブ機能を検討する可能性はあるが、初期バージョンでは対象外

## 9. スキーマ変更メモ

現在のスキーマから以下の変更が必要：

### 既存テーブルの変更

- **`events.venue` を NOT NULL に変更** — イベント作成時に必須
- **`events.date` / `events.startTime` / `events.openTime` を削除し、`events.startDatetime` (text, NOT NULL) / `events.openDatetime` (text, nullable) に統合** — `"YYYY-MM-DDTHH:mm"` 形式（JST 固定）。フォーム入力の開催日 + 時刻を結合して保存する
- **`event_members.allotment` を削除** — 招待枠は出演者ごとではなくイベント共有プール（`events.totalSeats`）で管理する
- **`event_members.displayName` を NOT NULL に変更** — イベント作成時は `users.name` を初期値として設定。出演者招待時は主催者が入力した表示名を設定する
- **`invitations.companionCount` を削除** — 同伴者は人数ではなく名前で管理する
- **`invitations.guestName` を nullable に変更** — 招待作成時はゲスト未定。ゲストが回答時に入力する
- **`invitations.guestEmail` を nullable のまま維持** — 同上。ゲストが回答時に入力する（回答時は必須）
- **`invitations.memberId` を nullable に変更し、onDelete を `set null` に変更** — 出演者削除時に招待を維持するため
- **`invitations.status` の値セットを確認** — `pending` / `accepted` / `declined`（default: `pending`）。既存スキーマに定義がない場合は追加する
- **各テーブルの有効値セット（Drizzle の text enum オプションで TS 型制約 + アプリケーションレベルで制約）**:
  - `events.status`: `draft` / `published` / `ongoing` / `finished`（default: `draft`）
  - `event_members.role`: `organizer` / `performer`（default: `performer`）
  - `programs.type`: `performance` / `intermission` / `greeting` / `other`
- **`events.totalSeats` のバリデーション範囲を 0〜9999 に変更** — 0 は無制限を表す。座席枠チェック時に `totalSeats === 0` の場合はチェックをスキップする
- **`invitations.eventId` は既存カラムのため追加不要** — 現行スキーマに既に存在する（text, FK → events.id, NOT NULL, onDelete: cascade）。`memberId` が nullable になっても `eventId` でイベントを特定可能
- **`invitations.respondedAt` を維持** — ゲストが出欠回答を送信・変更するたびに更新する（最終回答日時として使用。既存カラム）
- **`invitations` に `inviterDisplayName` (text, NOT NULL) を追加** — 招待発行時の出演者表示名をスナップショットとして保存（出演者削除後も表示するため）
- **`invitations` に `checkedIn` (integer, boolean, default: false) を追加** — ゲスト本人のチェックイン状態
- **`invitations` に `checkedInAt` (integer, timestamp, nullable) を追加** — チェックイン日時
- **`invitations` に `invalidatedAt` (integer, timestamp, nullable) を追加** — 招待無効化の記録
- **`events.description` を削除** — 要件に説明文フィールドの仕様がなく、初期バージョンでは不要
- **`programs.order` を `sortOrder` にリネーム** — 要件内の命名に合わせる（SQL 予約語との衝突回避も兼ねる）
- **`programs.memberId` を削除** — 中間テーブル `program_performers` に移行
- **`check_ins` テーブルを削除** — チェックイン状態は `invitations.checkedIn` と `companions.checkedIn` で管理する

### 新設テーブル

#### `companions` テーブル

| カラム | 型 | 説明 |
|--------|------|------|
| `id` | text (PK) | UUID |
| `invitationId` | text (FK → invitations.id, onDelete: cascade) | 紐づく招待 |
| `name` | text (NOT NULL) | 同伴者の名前（1〜100 文字） |
| `checkedIn` | integer (boolean) | 来場済みフラグ（default: false） |
| `checkedInAt` | integer (timestamp, nullable) | チェックイン日時 |
| `createdAt` | integer (timestamp) | 作成日時 |
| `updatedAt` | integer (timestamp) | 更新日時 |

#### `program_performers` テーブル

| カラム | 型 | 説明 |
|--------|------|------|
| `id` | text (PK) | UUID |
| `programId` | text (FK → programs.id, onDelete: cascade) | 紐づく演目 |
| `memberId` | text (FK → event_members.id, onDelete: restrict) | 紐づく出演者（出演者削除前にプログラムから外す必要がある） |
| `createdAt` | integer (timestamp) | 作成日時 |

> UNIQUE 制約: (`programId`, `memberId`) の組み合わせ

#### `performer_invitations` テーブル

| カラム | 型 | 説明 |
|--------|------|------|
| `id` | text (PK) | UUID |
| `eventId` | text (FK → events.id, onDelete: cascade) | 紐づくイベント |
| `token` | text (UNIQUE) | 招待トークン（URL-safe ランダム文字列） |
| `displayName` | text (NOT NULL) | 招待時に設定する表示名（1〜50 文字） |
| `status` | text | `pending` / `accepted` / `invalidated`（default: `pending`） |
| `acceptedByUserId` | text (FK → users.id, nullable, onDelete: set null) | 受諾したユーザー |
| `acceptedAt` | integer (timestamp, nullable) | 受諾日時 |
| `createdAt` | integer (timestamp) | 作成日時 |
| `updatedAt` | integer (timestamp) | 更新日時 |

> **ゲスト招待との無効化アプローチの違い**: ゲスト招待（`invitations`）はソフトデリート方式（`invalidatedAt` タイムスタンプ）で無効化を管理する。出演者招待（`performer_invitations`）はステータス値（`invalidated`）で管理する。これは、ゲスト招待では無効化後も `accepted` のステータスを維持する必要がある（QRコード閲覧のため）のに対し、出演者招待では無効化＝使用不可の単純な状態遷移のためである。

## 10. 補足仕様・決定事項

実装上の補足事項と、検討の結果決定された方針。

### 認証・セッション

- **セッション有効期限**: Better Auth のデフォルト（7 日間）に従う。カスタム設定が必要なら別途検討
- **ログアウト後の遷移**: トップページ（`/`）にリダイレクトする
- **Google OAuth 失敗・キャンセル時**: トップページにリダイレクトし、エラートーストを表示する

### イベント管理

- **`events.startDatetime` / `events.openDatetime` の定義**: `startDatetime` は開催日+開演時刻（`"YYYY-MM-DDTHH:mm"` 形式、NOT NULL）、`openDatetime` は開催日+開場時刻（同形式、nullable）。フォーム入力では開催日（date）と時刻（time）を別々に受け取り、アプリケーション層で結合して保存する
- **タイムゾーン**: 日本国内利用を前提とし、JST 固定とする。DB に保存される日時の値（`"YYYY-MM-DDTHH:mm"`）はすべて JST として解釈する
- **`events.totalSeats` の 0 値**: 0 は無制限を表す。座席枠チェック（出席回答時・座席数変更時）で `totalSeats === 0` の場合はチェックをスキップする
- **イベント作成/参加の上限**: 初期バージョンでは上限を設けない

### 招待管理

- **招待の無効化の実装**: ソフトデリート方式。`invitations.invalidatedAt` に日時を記録し、ステータスは変更しない。統計では無効化済みの招待も件数に含める（「無効化済み」ラベル付き）
- **ゲストの回答変更回数**: 上限を設けない（`published` の間は何度でも変更可能）

### チェックイン

- **オフライン対応**: 初期バージョンでは対応しない。ネットワーク接続が必要

### その他

- **ブラウザ対応**: モダンブラウザ最新2バージョン（Chrome, Safari, Edge）。IE 非対応
- **OGP メタデータ**: 招待リンク（`/i/[token]`）共有時にイベント名を含むプレビューカードを表示する。出演者招待リンク（`/join/[token]`）も同様
- **Rate Limiting**: 初期バージョンでは設けない。将来的にトークン総当たり対策として導入を検討
- **ログ・監査**: 初期バージョンでは設けない
- **デプロイ環境**: 本番は Cloudflare Pages + D1。開発は SQLite（better-sqlite3）
